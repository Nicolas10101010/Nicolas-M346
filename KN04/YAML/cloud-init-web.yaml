#cloud-config                                    # Magic String: Zeigt an, dass dies eine Cloud-init Config ist
users: # Liste von Benutzern, die erstellt werden sollen
  - name: ubuntu # Benutzername: "ubuntu" (der Standard-User)
    groups: [users, admin] # Füge diesen User zu den Gruppen "users" und "admin" hinzu
    shell: /bin/bash # Standard-Shell für diesen User (Bash)
    sudo: ALL=(ALL) NOPASSWD:ALL # sudo-Regel: User kann ALLE Befehle als sudo ausführen, OHNE Passwort eingeben zu müssen
    ssh_authorized_keys: # Liste von SSH Public Keys, die sich einloggen dürfen
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0MABxv8adiwJh4kFYhBvK2tzkp89LOVSZCG5nGgyM88UmQi/pBpoDlGztezeXnXsNqG4ytNcFeN+NhFnDSLqkrM2wgvN7/9ZoITGsemiNy9aneYDPrNAyxqyuQth1rLZ9vcUAYN+yKp2u1torf/ioK4QR02eK9geqsoJVAavVlvyqkHg84pxi/aFrsJvR0CaQvREOiZZM6tk0Pw+bdNnHU5qzoGm4ll07ziIXmY9uerJ/uTCaVV6dQ49rYiejky7dX+OVx/8E6qLmW+fgSrbxDN38uZUo22DXHKNtbQIUe/C+pB9m4eJ8TY6gxAqiSKOX6uF38dHVAteSKyc11AXL aws-key # Erster SSH Public Key (eigener Key)
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0WGP1EZykEtv5YGC9nMiPFW3U3DmZNzKFO5nEu6uozEHh4jLZzPNHSrfFTuQ2GnRDSt+XbOtTLdcj26+iPNiFoFha42aCIzYjt6V8Z+SQ9pzF4jPPzxwXfDdkEWylgoNnZ+4MG1lNFqa8aO7F62tX0Yj5khjC0Bs7Mb2cHLx1XZaxJV6qSaulDuBbLYe8QUZXkMc7wmob3PM0kflfolR3LE7LResIHWa4j4FL6r5cQmFlDU2BDPpKMFMGUfRSFiUtaWBNXFOWHQBC2+uKmuMPYP4vJC9sBgqMvPN/X2KyemqdMvdKXnCfrzadHuSSJYEzD64Cve5Zl9yVvY4AqyBD aws-key-lehrperson # Zweiter SSH Public Key (Lehrperson)

ssh_pwauth: false # SSH Passwort-Authentifizierung DEAKTIVIERT (nur Key-basiert erlaubt)
disable_root: false # Root-User NICHT deaktivieren (root bleibt aktiv, aber Login nur per Key)
package_update: true # Führe "apt update" beim ersten Boot aus (aktualisiert Paketliste)
packages: # Liste von Paketen, die automatisch installiert werden sollen
  - apache2 # Installiere Apache2 Webserver
  - php # Installiere PHP
  - libapache2-mod-php # Apache-Modul für PHP-Unterstützung
  - php-mysql # PHP-Modul für MySQL/MariaDB-Verbindungen
  - adminer # Installiere Adminer (webbasierte Datenbank-Verwaltung)

write_files: # Erstelle Dateien auf dem Server
  - path: /var/www/html/index.html # Pfad zur Index-Datei (Startseite)
    content: | # Inhalt der Datei (mehrzeilig)
      <!DOCTYPE html>
      <html>
      <head>
          <title>M346 Webserver</title>
      </head>
      <body>
          <h1>Willkommen auf dem Webserver</h1>
          <p>Cloud-init Installation erfolgreich!</p>
          <ul>
              <li><a href="info.php">PHP Info</a></li>
              <li><a href="db.php">Datenbank Test</a></li>
              <li><a href="adminer/">Adminer</a></li>
          </ul>
      </body>
      </html>

  - path: /var/www/html/db.php # Pfad zur DB-Test-Datei
    content: | # Inhalt der Datei
      <?php
      $servername = "172.31.29.103";             # Private IP-Adresse der Datenbank-Instanz
      $username = "admin";                       # Datenbank-Benutzername
      $password = "M346_Nicolas";                # Datenbank-Passwort

      // Verbindung zur Datenbank erstellen
      $conn = new mysqli($servername, $username, $password);

      // Verbindung überprüfen
      if ($conn->connect_error) {
          die("Verbindung fehlgeschlagen: " . $conn->connect_error);
      }
      echo "Erfolgreich mit MySQL verbunden";
      ?>

  - path: /var/www/html/info.php # Pfad zur PHP-Info-Datei
    content: | # Inhalt der Datei
      <?php phpinfo(); ?>                        # Zeigt PHP-Konfiguration an

runcmd: # Liste von Befehlen, die nach der Installation ausgeführt werden
  - a2enconf adminer # Aktiviere Adminer-Konfiguration für Apache
  - systemctl restart apache2 # Starte Apache-Webserver neu, damit alle Änderungen wirksam werden
